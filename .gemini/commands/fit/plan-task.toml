description = "为任务设计技术方案并输出实施计划"
prompt = """
请为任务 {{args}} 设计技术方案。

**检查任务文件**:
!{if [ -f .ai-workspace/active/{{args}}/task.md ]; then echo "✅ 任务存在于 active"; else echo "⚠️ 任务不在 active 目录"; fi}

**查找任务位置**:
!{find .ai-workspace -type f -path "*/{{args}}/task.md" 2>/dev/null || echo "❌ 任务文件未找到"}

执行以下步骤:

1. **验证前置条件**:
   - 如果任务文件未找到，报错并退出。
   - 读取 `task.md` 和 `analysis.md` (使用 `read_file`)。
   - 如果 `analysis.md` 不存在，提示用户先运行 `/fit:analyze-issue`。

2. **理解问题本质和约束条件**:
   - 基于 `analysis.md` 理解根本原因、影响范围和技术约束。
   - 识别特殊要求（安全、回归、扩展性）。

3. **设计解决方案**:
   - 提出多个可行方案并对比优劣。
   - 选择最合适的方案。
   - 制定详细实施步骤。
   - 列出需要创建/修改的文件清单。
   - 设计验证策略（测试、回归）。
   - 评估影响（性能、安全、兼容性）。
   - 制定风险控制和回滚方案。

4. **输出方案文档**:
   在任务目录下创建 `plan.md`, 包含:
   - 方案决策 (问题理解, 约束, 方案对比, 最终选择)
   - 技术方案 (核心策略, 关键技术点, 实现细节)
   - 实施步骤 (详细步骤列表)
   - 文件清单 (创建/修改的文件)
   - 验证策略 (功能/问题/回归验证)
   - 影响评估
   - 风险控制

5. **更新任务状态**:
   - 修改 `task.md`:
     - current_step: technical-design
     - updated_at: 当前时间
     - 标记技术方案设计为完成

6. **告知用户**:
   - 输出方案概要
   - 显示输出文件路径
   - **提示这是人工审查检查点**: 使用 `/fit:implement-task {{args}}` 开始实施前必须经过审查。

**注意事项**:
- 必须先完成需求分析。
- 方案设计完成后**必须**等待人工审查。
"""
