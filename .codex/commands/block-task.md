---
description: 标记任务阻塞并记录阻塞原因
usage: /block-task <task-id> [--reason <阻塞原因>]
argument-hint: <task-id> [--reason=<reason>]
---

# Block Task Command

## 使用前：自动识别仓库

命令会默认使用当前工作目录所在的 Git 仓库作为目标，无需传入仓库参数。若当前目录不在 Git 仓库内，请先 `cd` 到目标仓库根目录后再执行。

文中所有路径示例默认以仓库根目录为基准。

## 功能说明

当任务遇到无法继续的问题时，使用此命令标记任务为阻塞状态，记录详细的阻塞原因，并将任务移动到 `blocked` 目录，等待问题解决。

## ⚠️ CRITICAL: 状态更新要求

执行此命令后，你**必须**立即更新任务状态并移动任务目录。参见规则 7。

## 使用场景

### 何时使用此命令

在以下情况下应该标记任务为阻塞：

**技术问题**：
- ❌ 编译失败且无法修复
- ❌ 测试失败且原因不明
- ❌ 依赖库存在 Bug
- ❌ 环境配置问题
- ❌ 工具链问题

**需求问题**：
- ❓ 需求不明确，需要澄清
- ❓ 发现需求冲突
- ❓ 缺少必要的需求信息
- ❓ 需要产品决策

**资源问题**：
- ⏳ 等待外部依赖
- ⏳ 等待第三方 API 或服务
- ⏳ 等待数据库迁移
- ⏳ 等待基础设施就绪

**决策问题**：
- 🤔 需要架构决策
- 🤔 需要安全审查
- 🤔 需要性能优化方案选择
- 🤔 需要人工审查和批准

### 何时不使用此命令

以下情况**不应该**标记为阻塞：

- ✅ 代码审查发现问题 → 使用 `/refinement-task` 修复
- ✅ 实现遇到困难但可以解决 → 继续实施
- ✅ 测试失败但原因清楚 → 修复测试
- ✅ 文档不完整 → 完善文档

## 执行流程

### 1. 验证任务存在

检查任务文件是否存在：
```bash
ls -la .ai-workspace/active/{task-id}/task.md
```

如果任务不在 `active` 目录，检查是否已经在 `blocked` 或 `completed` 目录。

### 2. 分析阻塞原因

在标记阻塞前，必须仔细分析并记录以下信息：

**问题描述**：
- 遇到了什么具体问题？
- 问题出现在哪个步骤？
- 问题的表现形式是什么？

**根本原因**：
- 为什么会出现这个问题？
- 问题的根源是什么？
- 是否有错误日志或诊断信息？

**尝试的解决方案**：
- 已经尝试了哪些方法？
- 为什么这些方法没有解决问题？

**需要的帮助**：
- 需要谁来帮助解决？
- 需要什么资源或信息？
- 预计解决问题需要多长时间？

### 3. 更新任务状态 (CRITICAL)

**必须更新** `.ai-workspace/active/{task-id}/task.md`：

```yaml
status: blocked
current_step: {当前步骤，保持不变}
updated_at: {当前时间，格式: yyyy-MM-dd HH:mm:ss}
blocked_at: {当前时间，格式: yyyy-MM-dd HH:mm:ss}
blocked_by: {当前AI}
blocked_reason: {简短描述阻塞原因}
```

**在 task.md 中添加"阻塞信息"章节**（在 "注意事项" 之前插入）：

```markdown
---

## ⚠️ 阻塞信息

### 阻塞概要

- **阻塞时间**: {当前时间}
- **阻塞步骤**: {current_step}
- **阻塞者**: {当前AI}
- **阻塞类型**: {技术问题/需求问题/资源问题/决策问题}
- **严重程度**: {高/中/低}
- **预计解决时间**: {预估}

### 问题描述

{详细描述遇到的问题，包括错误信息、日志、截图等}

### 根本原因

{分析问题的根本原因}

### 尝试的解决方案

1. **尝试方法 1**: {描述}
   - 结果: {失败/部分成功}
   - 原因: {为什么没有解决}

2. **尝试方法 2**: {描述}
   - 结果: {失败/部分成功}
   - 原因: {为什么没有解决}

### 需要的帮助

**需要谁**：{开发者/架构师/产品经理/运维/安全团队}

**需要什么**：
- 明确 XX 需求
- 解决 XX 技术问题
- 提供 XX 资源
- 做出 XX 决策

**附加信息**：
{任何有助于解决问题的额外信息}

### 解除阻塞条件

满足以下条件后可以解除阻塞并继续：
- [ ] 条件 1
- [ ] 条件 2
- [ ] 条件 3

### 备用方案

如果问题无法在合理时间内解决，可以考虑：
- 方案 1: {描述}
- 方案 2: {描述}

---
```

### 4. 移动到阻塞目录 (CRITICAL)

将任务从 `active` 目录移动到 `blocked` 目录：

```bash
# 确保 blocked 目录存在
mkdir -p .ai-workspace/blocked

# 移动任务目录
mv .ai-workspace/active/{task-id} .ai-workspace/blocked/
```

**验证移动成功**：
```bash
# 验证源目录不存在
test ! -d .ai-workspace/active/{task-id} && echo "已移除 active 目录" || echo "ERROR: active 目录仍存在"

# 验证目标目录存在
test -d .ai-workspace/blocked/{task-id} && echo "已移动到 blocked" || echo "ERROR: 移动失败"
```

### 5. 可选：同步到 Issue

如果任务关联了 GitHub Issue，使用 `/sync-issue` 更新 Issue 状态：

```bash
/sync-issue {issue-number}
```

在 Issue 中添加阻塞说明：
```markdown
⚠️ 任务当前处于阻塞状态

**阻塞时间**: {当前时间}
**阻塞原因**: {简短描述}
**需要帮助**: {需要什么}

详细信息请查看任务文件：`.ai-workspace/blocked/{task-id}/task.md`
```

可以添加 `blocked` 标签到 Issue。

### 6. 通知相关人员

告知用户和相关人员任务已阻塞：

**输出格式**：
```
⚠️  任务 {task-id} 已标记为阻塞

**任务信息**：
- 任务ID: {task-id}
- 任务类型: {type}
- 阻塞步骤: {current_step}
- 阻塞时间: {当前时间}

**阻塞原因**：
{阻塞原因简短描述}

**需要的帮助**：
{需要谁来帮助，需要什么}

**阻塞位置**：
- `.ai-workspace/blocked/{task-id}/`

**下一步**：
1. 查看任务文件中的"阻塞信息"章节了解详情
2. 解决阻塞问题
3. 使用 /unblock-task 命令解除阻塞（如果实现了该命令）
   或手动移回 active 目录：
   ```bash
   mv .ai-workspace/blocked/{task-id} .ai-workspace/active/
   # 然后更新 task.md 中的 status 为 active，移除 blocked_* 字段
   ```

**关联资源**：
- Issue: #{issue-number}（已同步）
- 相关文档: {列出相关文档}
```

### 7. 创建阻塞日志（可选）

在项目中维护一个阻塞任务列表：

```bash
# 添加到阻塞日志
echo "{当前时间} | {task-id} | {阻塞原因} | {需要帮助}" >> .ai-workspace/logs/blocked-tasks.log
```

## ✅ 完成检查清单

执行此命令后，确认：

- [ ] 已详细分析阻塞原因
- [ ] 已更新 task.md 中的 `status` 为 blocked
- [ ] 已更新 task.md 中的 `updated_at` 为当前时间
- [ ] 已添加 task.md 中的 `blocked_at` 字段
- [ ] 已添加 task.md 中的 `blocked_by` 字段
- [ ] 已添加 task.md 中的 `blocked_reason` 字段
- [ ] 已在 task.md 中添加完整的"阻塞信息"章节
- [ ] 已将任务从 active 移动到 blocked 目录
- [ ] 已验证移动成功
- [ ] 如果有关联 Issue，已同步更新
- [ ] 已通知用户和相关人员
- [ ] 已说明解除阻塞的条件

## 解除阻塞

当问题解决后，手动解除阻塞：

```bash
# 将任务移回 active 目录
mv .ai-workspace/blocked/{task-id} .ai-workspace/active/
```

**更新 task.md**：
```yaml
status: active
# 移除以下字段：
# blocked_at
# blocked_by
# blocked_reason
```

**在"阻塞信息"章节添加解决记录**：
```markdown
### 解决记录

- **解决时间**: {当前时间}
- **解决者**: {解决者}
- **解决方式**: {如何解决的}
- **阻塞时长**: {从阻塞到解决的时间}
```

然后继续任务执行。

## 常见问题

### Q: 如果不确定是否应该标记为阻塞怎么办？

A: 遵循以下原则：
- 如果问题**你无法解决**，需要外部帮助 → 标记阻塞
- 如果问题**你可以解决**，只是需要时间 → 不标记阻塞
- 如果**不确定**，先尝试解决 1-2 小时，仍无进展再标记阻塞

### Q: 可以在任何步骤标记阻塞吗？

A: 可以。任何步骤遇到无法解决的问题都应该标记阻塞，而不是强行继续。

### Q: 阻塞原因应该写多详细？

A: 越详细越好。想象你在写一个故障报告，目标是让接手的人能快速理解问题并解决。

### Q: 如果有多个阻塞问题怎么办？

A: 在"阻塞信息"章节中列出所有问题，按优先级排序。

### Q: 阻塞的任务还会被追踪吗？

A: 会。应该定期检查 `blocked` 目录中的任务，确保问题得到关注和解决。

### Q: 是否需要设置阻塞超时？

A: 建议在"阻塞信息"中标注"预计解决时间"。如果超过预期时间仍未解决，应该：
1. 重新评估问题
2. 考虑备用方案
3. 升级问题优先级

## 阻塞类型和处理建议

### 技术问题阻塞

**特征**：编译失败、测试失败、工具问题
**处理**：
1. 收集详细的错误日志
2. 搜索类似问题的解决方案
3. 如果是工具 Bug，报告给工具维护者
4. 考虑使用替代工具或方法

### 需求问题阻塞

**特征**：需求不清晰、需求冲突
**处理**：
1. 列出具体的疑问点
2. 提供多个可能的解释
3. 标注每个解释的影响
4. 请产品经理或用户澄清

### 资源问题阻塞

**特征**：等待外部依赖、服务不可用
**处理**：
1. 明确等待的资源和预计时间
2. 检查是否有临时替代方案
3. 考虑并行进行其他工作
4. 跟踪资源的准备进度

### 决策问题阻塞

**特征**：需要架构决策、方案选择
**处理**：
1. 列出所有可行方案
2. 分析每个方案的优缺点
3. 提供推荐方案和理由
4. 请相关人员做出决策

## 注意事项

### 及时标记

- 不要拖延。一旦确定问题无法解决，立即标记阻塞
- 不要试图"硬推"。强行继续可能导致更大问题

### 清晰沟通

- 阻塞信息要详细、准确、客观
- 避免使用模糊的描述，如"有些问题"、"不太行"
- 提供具体的错误信息、日志、复现步骤

### 主动跟进

- 标记阻塞后，要主动跟进问题解决进度
- 定期更新阻塞状态
- 如果有新的信息或尝试，及时更新"阻塞信息"章节

## 相关命令

- `/task-status` - 查看任务状态，包括阻塞任务
- `/sync-issue` - 同步阻塞状态到 GitHub Issue
- `/unblock-task` - 解除阻塞（如果实现了该命令）

## 工作流位置

此命令可以在任何工作流步骤中使用，当遇到无法继续的问题时执行。

## 示例

```bash
# 标记任务为阻塞，并指定原因
/block-task TASK-20260103-135501 --reason "编译失败：缺少依赖 org.example:foo:1.2.3"

# 仅标记为阻塞，后续手动编辑详细原因
/block-task TASK-20260103-135501
```

## 统计和监控

建议定期检查阻塞任务：

```bash
# 列出所有阻塞任务
ls -la .ai-workspace/blocked/

# 统计阻塞任务数量
ls -1 .ai-workspace/blocked/ | wc -l

# 查看阻塞任务的阻塞时长
# 可以编写脚本分析 blocked_at 字段
```

对于长期阻塞的任务，考虑：
1. 重新评估优先级
2. 寻求额外资源
3. 考虑取消任务
