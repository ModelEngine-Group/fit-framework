# AI 编程沙箱环境
#
# 包含开发运行时 + AI TUI 工具（Claude Code、Codex 等）
# 所有 AI 工具在容器内运行，实现物理隔离

FROM ubuntu:22.04

LABEL description="AI coding sandbox with runtime and TUI tools"
LABEL version="3.6.3-SNAPSHOT"

ENV DEBIAN_FRONTEND=noninteractive
ENV TZ=Asia/Shanghai

# 创建非特权用户（UID/GID 与宿主机对齐，避免文件权限问题）
ARG HOST_UID=1000
ARG HOST_GID=1000
RUN (groupadd -g ${HOST_GID} devuser || true) && \
    useradd -u ${HOST_UID} -g ${HOST_GID} -m -s /bin/bash devuser

# 基础工具 + 中文 locale
RUN apt-get update && apt-get install -y \
    curl wget git vim \
    build-essential ca-certificates gnupg lsb-release \
    locales \
    && locale-gen en_US.UTF-8 \
    && rm -rf /var/lib/apt/lists/*

ENV LANG=en_US.UTF-8
ENV LC_ALL=en_US.UTF-8
ENV TERM=xterm-256color
ENV COLORTERM=truecolor

# Node.js 20 LTS（Claude Code 和 Codex 需要 Node 18+）
RUN curl -fsSL https://deb.nodesource.com/setup_20.x | bash - && \
    apt-get install -y nodejs && \
    rm -rf /var/lib/apt/lists/*

# Java + Maven
RUN apt-get update && apt-get install -y \
    openjdk-17-jdk maven \
    && rm -rf /var/lib/apt/lists/*

# Python
RUN apt-get update && apt-get install -y \
    python3 python3-pip python3-venv \
    && rm -rf /var/lib/apt/lists/*

# 在 /home 下创建工作目录的软链接，方便进入容器后快速定位
RUN ln -s /workspace /home/devuser/workspace

# AI TUI 工具（以 devuser 身份安装到用户目录，避免权限问题）
USER devuser
ENV NPM_CONFIG_PREFIX=/home/devuser/.npm-global
ENV PATH="/home/devuser/.npm-global/bin:${PATH}"

RUN npm install -g @anthropic-ai/claude-code && \
    npm install -g @openai/codex

# 默认信任 /workspace 挂载目录（避免 dubious ownership 错误）
RUN git config --global --add safe.directory /workspace

# 写入环境变量到 .bashrc（交互式 shell 自动加载）
RUN echo 'export NPM_CONFIG_PREFIX=/home/devuser/.npm-global' >> /home/devuser/.bashrc && \
    echo 'export PATH="/home/devuser/.npm-global/bin:${PATH}"' >> /home/devuser/.bashrc && \
    echo 'export GIT_CONFIG_GLOBAL=/home/devuser/.gitconfig' >> /home/devuser/.bashrc && \
    echo 'export CLAUDE_CONFIG_DIR=/home/devuser/.claude' >> /home/devuser/.bashrc

WORKDIR /workspace

CMD ["tail", "-f", "/dev/null"]
